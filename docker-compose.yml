services:
  iaq4j:
    build: .
    container_name: iaq4j
    restart: unless-stopped
    user: "1000:1000"
    read_only: true
    tmpfs:
      - /tmp:size=64m
    environment:
      - ROOT_PATH=/iaq
      - API_KEY=${API_KEY:-}
    ports:
      - "127.0.0.1:8001:8000"
    volumes:
      - ./trained_models:/app/trained_models:ro
      - ./database_config.yaml:/app/database_config.yaml:ro
      - ./model_config.yaml:/app/model_config.yaml:ro
    networks:
      - iotstack_default
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "2.0"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  iotstack_default:
    external: true
